<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher's Worksheet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #374151; }
        .container { max-width: 1200px; margin: 2rem auto; padding: 2rem; background-color: #ffffff; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 1rem; border-radius: 0.75rem; overflow: hidden; }
        th, td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid #e5e7eb; white-space: nowrap; }
        th { background-color: #f9fafb; font-weight: 600; color: #1f2937; text-transform: uppercase; font-size: 0.875rem; }
        tr:last-child td { border-bottom: none; }
        tr:nth-child(odd) { background-color: #f9fafb; }
        tr:nth-child(even) { background-color: #ffffff; }
        input[type="text"], input[type="password"], input[type="email"] { padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; width: 100%; box-sizing: border-box; background-color: #f9fafb; transition: border-color 0.2s; }
        input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }
        .btn { padding: 0.75rem 1.5rem; background-color: #2563eb; color: white; border-radius: 0.75rem; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; }
        .btn:hover { background-color: #1d4ed8; transform: translateY(-1px); }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .message-box { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #fff; padding: 2rem; border-radius: 0.75rem; box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1); z-index: 1001; text-align: center; }
        .modal { display: none; position: fixed; z-index: 1002; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 0.75rem; }
        .login-container { max-width: 400px; margin: 5rem auto; padding: 2rem; background: white; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .change-log { max-height: 200px; overflow-y: auto; border: 1px solid #e5e7eb; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; }
        .change-entry { padding: 0.5rem; border-bottom: 1px solid #e5e7eb; }
        .change-entry:last-child { border-bottom: none; }
    </style>
</head>
<body>
    <!-- Login Screen (shown first) -->
    <div id="loginScreen" class="login-container">
        <h1 class="text-2xl font-bold text-center mb-6">Teacher's Worksheet Login</h1>
        <div class="mb-4">
            <label class="block text-gray-700 mb-2">Username</label>
            <input type="text" id="loginUsername" class="w-full p-2 border rounded">
        </div>
        <div class="mb-4">
            <label class="block text-gray-700 mb-2">Email</label>
            <input type="email" id="loginEmail" class="w-full p-2 border rounded">
        </div>
        <div class="mb-6">
            <label class="block text-gray-700 mb-2">Password</label>
            <input type="password" id="loginPassword" class="w-full p-2 border rounded">
        </div>
        <button id="loginBtn" class="btn w-full">Login</button>
        <p id="loginError" class="text-red-500 mt-2 text-center hidden">Invalid credentials</p>
    </div>

    <!-- Main Application (hidden until login) -->
    <div id="appContainer" class="container hidden">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Teacher's Worksheet</h1>
            <div class="flex items-center space-x-4">
                <span id="currentUser" class="font-medium"></span>
                <button id="logoutBtn" class="btn bg-red-500 hover:bg-red-600">Logout</button>
            </div>
        </div>

        <!-- Change Log Section -->
        <div class="mb-8 p-4 bg-yellow-50 rounded-lg">
            <h2 class="text-xl font-semibold mb-2">Recent Changes</h2>
            <div id="changeLog" class="change-log">
                <!-- Changes will appear here -->
                <p class="text-gray-500">No changes yet</p>
            </div>
        </div>

        <!-- Month and Year Selectors -->
        <div class="mb-6 flex items-center justify-center space-x-4">
            <label for="monthSelect" class="font-medium text-gray-700">Month:</label>
            <select id="monthSelect" class="p-2 border border-gray-300 rounded-md">
                <!-- Options populated by JavaScript -->
            </select>

            <label for="yearSelect" class="font-medium text-gray-700">Year:</label>
            <select id="yearSelect" class="p-2 border border-gray-300 rounded-md">
                <!-- Options populated by JavaScript -->
            </select>
        </div>

        <!-- Attendance Sheet Section -->
        <div class="mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Attendance Sheet</h2>
            <div id="attendanceTableContainer" class="overflow-x-auto rounded-lg shadow-md">
                <table class="min-w-full bg-white">
                    <thead>
                        <tr id="attendanceHeaderWeekRow">
                            <th class="w-1/6" rowspan="2">Student Name</th>
                            <th rowspan="2">Notes</th>
                            <!-- Week headers populated by JavaScript -->
                        </tr>
                        <tr id="attendanceHeaderDayRow">
                            <!-- Day headers populated by JavaScript -->
                        </tr>
                    </thead>
                    <tbody id="attendanceBody">
                        <!-- Attendance rows populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Timetable Section -->
        <div class="mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Timetable</h2>
            <div id="timetableTableContainer" class="overflow-x-auto rounded-lg shadow-md">
                <table class="min-w-full bg-white">
                    <thead>
                        <tr id="timetableHeaderRow">
                            <th class="w-1/6">Time Slot</th>
                            <!-- Date headers populated by JavaScript -->
                        </tr>
                    </thead>
                    <tbody id="timetableBody">
                        <!-- Timetable rows populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            <div class="flex justify-start space-x-4 mt-4">
                <button id="addTimeSlotBtn" class="btn">Add Time Slot</button>
                <button id="generateLessonIdeaBtn" class="btn bg-pink-600 hover:bg-pink-700">✨ Tajweed Lesson Idea</button>
            </div>
        </div>

        <!-- Student Contact Information Section -->
        <div class="mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Student Contact Information</h2>
            <div id="privateContactTableContainer" class="overflow-x-auto rounded-lg shadow-md">
                <table class="min-w-full bg-white">
                    <thead>
                        <tr>
                            <th class="w-1/4">Student Name</th>
                            <th class="w-1/4">Phone Number</th>
                            <th class="w-1/4">Email</th>
                            <th class="w-1/4">Notes</th>
                        </tr>
                    </thead>
                    <tbody id="privateContactBody">
                        <!-- Private contact rows populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Overall Attendance Summary Section -->
        <div class="mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Overall Attendance Summary</h2>
            <div id="overallAttendanceTableContainer" class="overflow-x-auto rounded-lg shadow-md">
                <table class="min-w-full bg-white">
                    <thead>
                        <tr>
                            <th class="w-1/3">Student Name</th>
                            <th class="text-center">Days Attended</th>
                            <th class="text-center">Attendance Percentage</th>
                            <th>Insights</th>
                        </tr>
                    </thead>
                    <tbody id="overallAttendanceBody">
                        <!-- Overall attendance summary populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="text-center mt-8 space-x-4">
            <button id="saveDataBtn" class="btn">Save All Data</button>
            <button id="printWorksheetBtn" class="btn bg-gray-600 hover:bg-gray-700">Print Worksheet</button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <p>Loading data...</p>
    </div>

    <!-- Message Box -->
    <div id="messageBox" class="message-box hidden">
        <p id="messageText"></p>
        <button onclick="document.getElementById('messageBox').style.display='none'" class="btn mt-4">OK</button>
    </div>

    <!-- Note Modal -->
    <div id="noteModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button" onclick="document.getElementById('noteModal').style.display='none'">&times;</span>
            <h3 class="text-xl font-semibold mb-4" id="noteModalTitle">Add/Edit Note</h3>
            <textarea id="noteTextArea" class="w-full"></textarea>
            <button id="saveNoteBtn" class="btn mt-4">Save Note</button>
        </div>
    </div>

    <script>
        // Hardcoded login credentials
        const VALID_USERNAME = "Mariam";
        const VALID_EMAIL = "mariam208@gmail.com";
        const VALID_PASSWORD = "teacher123"; // Simple password for demo purposes

        // Application state
        let currentUser = null;
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let monthDates = [];
        let changeLog = [];

        // Student data
        const studentNames = [
            "NAJMA ABSHIR",
            "HAMDA AHMED",
            "ASHA HASSAN",
            "KHULUUD ABDIRAHMAN",
            "NAJMA ABDINASSIR",
            "SAHRA ABDIRASHID"
        ];

        // Data structures
        let attendanceData = [];
        let timetableData = [];
        let privateContactData = [];

        // DOM elements
        const loginScreen = document.getElementById('loginScreen');
        const appContainer = document.getElementById('appContainer');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const loginUsername = document.getElementById('loginUsername');
        const loginEmail = document.getElementById('loginEmail');
        const loginPassword = document.getElementById('loginPassword');
        const loginError = document.getElementById('loginError');
        const currentUserDisplay = document.getElementById('currentUser');
        const changeLogContainer = document.getElementById('changeLog');

        // Initialize the application
        function initApp() {
            setupEventListeners();
            checkLoginStatus();
        }

        // Check if user is already logged in (for page refresh)
        function checkLoginStatus() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showApp();
            }
        }

        // Setup all event listeners
        function setupEventListeners() {
            // Login button
            loginBtn.addEventListener('click', handleLogin);
            
            // Logout button
            logoutBtn.addEventListener('click', handleLogout);
            
            // Allow Enter key to submit login
            loginPassword.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
        }

        // Handle login
        function handleLogin() {
            const username = loginUsername.value.trim();
            const email = loginEmail.value.trim();
            const password = loginPassword.value.trim();

            if (username === VALID_USERNAME && 
                email === VALID_EMAIL && 
                password === VALID_PASSWORD) {
                
                currentUser = { username, email };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                showApp();
            } else {
                loginError.classList.remove('hidden');
            }
        }

        // Handle logout
        function handleLogout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            showLogin();
            loginUsername.value = '';
            loginEmail.value = '';
            loginPassword.value = '';
            loginError.classList.add('hidden');
        }

        // Show the main application
        function showApp() {
            loginScreen.classList.add('hidden');
            appContainer.classList.remove('hidden');
            currentUserDisplay.textContent = `Logged in as: ${currentUser.username} (${currentUser.email})`;
            
            // Initialize the worksheet
            populateMonthYearSelectors();
            initializeData();
            renderAll();
        }

        // Show the login screen
        function showLogin() {
            loginScreen.classList.remove('hidden');
            appContainer.classList.add('hidden');
        }

        // Track changes made by students
        function trackChange(changeDescription) {
            const timestamp = new Date().toLocaleString();
            changeLog.unshift({
                timestamp,
                user: currentUser.username,
                change: changeDescription
            });
            
            // Keep only the last 20 changes
            if (changeLog.length > 20) {
                changeLog.pop();
            }
            
            renderChangeLog();
            
            // In a real app, you would send this to the server to notify the teacher
            console.log(`Change detected: ${changeDescription} by ${currentUser.username}`);
        }

        // Render the change log
        function renderChangeLog() {
            if (changeLog.length === 0) {
                changeLogContainer.innerHTML = '<p class="text-gray-500">No changes yet</p>';
                return;
            }
            
            changeLogContainer.innerHTML = changeLog.map(entry => `
                <div class="change-entry">
                    <div class="flex justify-between">
                        <span class="font-medium">${entry.user}</span>
                        <span class="text-gray-500 text-sm">${entry.timestamp}</span>
                    </div>
                    <p class="text-sm mt-1">${entry.change}</p>
                </div>
            `).join('');
        }

        // Initialize all data structures
        function initializeData() {
            monthDates = generateMonthDates(currentYear, currentMonth);
            
            // Initialize attendance data
            attendanceData = studentNames.map(name => {
                const dailyAttendance = {};
                const dailyNotes = {};
                monthDates.forEach(dateInfo => {
                    dailyAttendance[dateInfo.fullDate] = false;
                    dailyNotes[dateInfo.fullDate] = "";
                });
                return {
                    name,
                    attendance: dailyAttendance,
                    notes: dailyNotes,
                    studentNote: ""
                };
            });
            
            // Initialize timetable data
            timetableData = [
                { time: "9:00 AM", dailySubjects: {} },
                { time: "10:00 AM", dailySubjects: {} },
                { time: "11:00 AM", dailySubjects: {} }
            ].map(slot => {
                const dailySubjects = {};
                monthDates.forEach(dateInfo => {
                    dailySubjects[dateInfo.fullDate] = { 
                        name: "Tajweed", 
                        checked: false, 
                        note: "" 
                    };
                });
                return {
                    time: slot.time,
                    dailySubjects
                };
            });
            
            // Initialize contact data
            privateContactData = studentNames.map(name => ({
                name,
                phone: "",
                email: "",
                privateNotes: ""
            }));
        }

        // Render all components
        function renderAll() {
            renderAttendance();
            renderTimetable();
            renderPrivateContactInfo();
            renderOverallAttendance();
            renderChangeLog();
        }

        // Generate dates for the selected month/year
        function generateMonthDates(year, monthIndex) {
            const dates = [];
            const date = new Date(year, monthIndex, 1);
            while (date.getMonth() === monthIndex) {
                const yyyy = date.getFullYear();
                const mm = String(date.getMonth() + 1).padStart(2, '0');
                const dd = String(date.getDate()).padStart(2, '0');
                const fullDate = `${yyyy}-${mm}-${dd}`;
                const shortDay = date.toLocaleDateString('en-US', { weekday: 'short' }).substring(0,2).toUpperCase();
                dates.push({
                    fullDate,
                    displayDate: date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
                    shortDay
                });
                date.setDate(date.getDate() + 1);
            }
            return dates;
        }

        // Populate month/year selectors
        function populateMonthYearSelectors() {
            const monthSelect = document.getElementById('monthSelect');
            const yearSelect = document.getElementById('yearSelect');
            
            monthSelect.innerHTML = '';
            yearSelect.innerHTML = '';
            
            const months = [
                "January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"
            ];
            
            months.forEach((month, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = month;
                monthSelect.appendChild(option);
            });
            
            const currentYearFull = new Date().getFullYear();
            for (let i = currentYearFull - 5; i <= currentYearFull + 5; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                yearSelect.appendChild(option);
            }
            
            monthSelect.value = currentMonth;
            yearSelect.value = currentYear;
            
            monthSelect.addEventListener('change', () => {
                currentMonth = parseInt(monthSelect.value);
                monthDates = generateMonthDates(currentYear, currentMonth);
                initializeData();
                renderAll();
                trackChange(`Changed month to ${months[currentMonth]}`);
            });
            
            yearSelect.addEventListener('change', () => {
                currentYear = parseInt(yearSelect.value);
                monthDates = generateMonthDates(currentYear, currentMonth);
                initializeData();
                renderAll();
                trackChange(`Changed year to ${currentYear}`);
            });
        }

        // Render attendance table
        function renderAttendance() {
            const attendanceBody = document.getElementById('attendanceBody');
            const attendanceHeaderWeekRow = document.getElementById('attendanceHeaderWeekRow');
            const attendanceHeaderDayRow = document.getElementById('attendanceHeaderDayRow');
            
            attendanceBody.innerHTML = '';
            attendanceHeaderWeekRow.innerHTML = '<th class="w-1/6" rowspan="2">Student Name</th><th rowspan="2">Notes</th>';
            attendanceHeaderDayRow.innerHTML = '';
            
            // Group dates into weeks
            const weeks = [];
            let tempWeek = [];
            monthDates.forEach((dateInfo, index) => {
                tempWeek.push(dateInfo);
                if ((index + 1) % 7 === 0 || index === monthDates.length - 1) {
                    weeks.push(tempWeek);
                    tempWeek = [];
                }
            });
            
            // Render week headers
            weeks.forEach((week, weekIndex) => {
                const weekTh = document.createElement('th');
                weekTh.className = `text-center ${weekIndex % 2 === 0 ? 'bg-green-500' : 'bg-blue-500'} text-white rounded-t-lg`;
                weekTh.colSpan = week.length;
                weekTh.textContent = `Week ${weekIndex + 1}`;
                attendanceHeaderWeekRow.appendChild(weekTh);
                
                // Render day headers
                week.forEach(dateInfo => {
                    const dayTh = document.createElement('th');
                    dayTh.className = "text-center";
                    dayTh.textContent = dateInfo.shortDay;
                    attendanceHeaderDayRow.appendChild(dayTh);
                });
            });
            
            // Render student rows
            attendanceData.forEach((student, studentIndex) => {
                const row = document.createElement('tr');
                let rowContent = `
                    <td>
                        <input type="text" class="student-name-input" data-index="${studentIndex}" value="${student.name}">
                    </td>
                    <td>
                        <button class="note-icon-btn" data-type="student-note" data-index="${studentIndex}">
                            &#9998;
                        </button>
                    </td>
                `;
                
                // Add attendance checkboxes
                monthDates.forEach(dateInfo => {
                    const isChecked = student.attendance[dateInfo.fullDate] || false;
                    rowContent += `
                        <td class="text-center">
                            <input type="checkbox" class="attendance-checkbox" 
                                   data-student-index="${studentIndex}" 
                                   data-date="${dateInfo.fullDate}" 
                                   ${isChecked ? 'checked' : ''}>
                        </td>
                    `;
                });
                
                row.innerHTML = rowContent;
                attendanceBody.appendChild(row);
            });
            
            // Add event listeners for student name changes
            document.querySelectorAll('.student-name-input').forEach(input => {
                input.addEventListener('change', (e) => {
                    const index = e.target.dataset.index;
                    const oldName = attendanceData[index].name;
                    const newName = e.target.value;
                    attendanceData[index].name = newName;
                    privateContactData[index].name = newName;
                    trackChange(`Changed student name from "${oldName}" to "${newName}"`);
                    renderPrivateContactInfo();
                    renderOverallAttendance();
                });
            });
            
            // Add event listeners for attendance checkboxes
            document.querySelectorAll('.attendance-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const studentIndex = e.target.dataset.studentIndex;
                    const date = e.target.dataset.date;
                    const studentName = attendanceData[studentIndex].name;
                    const newStatus = e.target.checked ? "present" : "absent";
                    attendanceData[studentIndex].attendance[date] = e.target.checked;
                    trackChange(`Marked ${studentName} as ${newStatus} on ${date}`);
                    renderOverallAttendance();
                });
            });
            
            // Add event listeners for note buttons
            document.querySelectorAll('.note-icon-btn[data-type="student-note"]').forEach(button => {
                button.addEventListener('click', (e) => {
                    const index = e.target.dataset.index;
                    openNoteModal('student', index);
                });
            });
        }

        // Render timetable
        function renderTimetable() {
            const timetableBody = document.getElementById('timetableBody');
            const timetableHeaderRow = document.getElementById('timetableHeaderRow');
            
            timetableBody.innerHTML = '';
            timetableHeaderRow.innerHTML = '<th class="w-1/6">Time Slot</th>';
            
            // Add date headers
            monthDates.forEach(dateInfo => {
                const th = document.createElement('th');
                th.className = "text-center";
                th.textContent = dateInfo.displayDate;
                timetableHeaderRow.appendChild(th);
            });
            
            // Render timetable rows
            timetableData.forEach((slot, slotIndex) => {
                const row = document.createElement('tr');
                let rowContent = `
                    <td>
                        <input type="text" class="time-slot-input" data-index="${slotIndex}" value="${slot.time}">
                    </td>
                `;
                
                // Add subject inputs and checkboxes
                monthDates.forEach(dateInfo => {
                    const subject = slot.dailySubjects[dateInfo.fullDate] || { 
                        name: "Tajweed", 
                        checked: false, 
                        note: "" 
                    };
                    
                    rowContent += `
                        <td>
                            <input type="text" class="subject-name-input" 
                                   data-slot-index="${slotIndex}" 
                                   data-date="${dateInfo.fullDate}" 
                                   value="${subject.name}">
                            <input type="checkbox" class="timetable-checkbox mt-1" 
                                   data-slot-index="${slotIndex}" 
                                   data-date="${dateInfo.fullDate}" 
                                   ${subject.checked ? 'checked' : ''}>
                            <button class="note-icon-btn" 
                                    data-type="timetable-note" 
                                    data-slot-index="${slotIndex}" 
                                    data-date="${dateInfo.fullDate}">
                                &#9998;
                            </button>
                        </td>
                    `;
                });
                
                row.innerHTML = rowContent;
                timetableBody.appendChild(row);
            });
            
            // Add event listeners for time slot changes
            document.querySelectorAll('.time-slot-input').forEach(input => {
                input.addEventListener('change', (e) => {
                    const index = e.target.dataset.index;
                    const oldTime = timetableData[index].time;
                    const newTime = e.target.value;
                    timetableData[index].time = newTime;
                    trackChange(`Changed time slot from "${oldTime}" to "${newTime}"`);
                });
            });
            
            // Add event listeners for subject name changes
            document.querySelectorAll('.subject-name-input').forEach(input => {
                input.addEventListener('change', (e) => {
                    const slotIndex = e.target.dataset.slotIndex;
                    const date = e.target.dataset.date;
                    const oldSubject = timetableData[slotIndex].dailySubjects[date].name;
                    const newSubject = e.target.value;
                    
                    if (!timetableData[slotIndex].dailySubjects[date]) {
                        timetableData[slotIndex].dailySubjects[date] = { 
                            name: "", 
                            checked: false, 
                            note: "" 
                        };
                    }
                    
                    timetableData[slotIndex].dailySubjects[date].name = newSubject;
                    trackChange(`Changed subject from "${oldSubject}" to "${newSubject}" on ${date}`);
                });
            });
            
            // Add event listeners for timetable checkboxes
            document.querySelectorAll('.timetable-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const slotIndex = e.target.dataset.slotIndex;
                    const date = e.target.dataset.date;
                    const newStatus = e.target.checked ? "completed" : "not completed";
                    
                    if (!timetableData[slotIndex].dailySubjects[date]) {
                        timetableData[slotIndex].dailySubjects[date] = { 
                            name: "", 
                            checked: false, 
                            note: "" 
                        };
                    }
                    
                    timetableData[slotIndex].dailySubjects[date].checked = e.target.checked;
                    trackChange(`Marked ${timetableData[slotIndex].time} on ${date} as ${newStatus}`);
                });
            });
            
            // Add event listeners for timetable note buttons
            document.querySelectorAll('.note-icon-btn[data-type="timetable-note"]').forEach(button => {
                button.addEventListener('click', (e) => {
                    const slotIndex = e.target.dataset.slotIndex;
                    const date = e.target.dataset.date;
                    openNoteModal('timetable', slotIndex, date);
                });
            });
            
            // Add event listener for Add Time Slot button
            document.getElementById('addTimeSlotBtn').addEventListener('click', () => {
                const newSlot = {
                    time: `New Slot ${timetableData.length + 1}`,
                    dailySubjects: {}
                };
                
                monthDates.forEach(dateInfo => {
                    newSlot.dailySubjects[dateInfo.fullDate] = { 
                        name: "Tajweed", 
                        checked: false, 
                        note: "" 
                    };
                });
                
                timetableData.push(newSlot);
                trackChange(`Added new time slot: ${newSlot.time}`);
                renderTimetable();
            });
            
            // Add event listener for Generate Lesson Idea button
            document.getElementById('generateLessonIdeaBtn').addEventListener('click', () => {
                const ideas = [
                    "Practice the rules of Noon Sakinah and Tanween with flash cards",
                    "Focus on proper Makhaarij (articulation points) with mirror exercises",
                    "Review the characteristics of letters (Sifaat) through group recitation",
                    "Practice stopping rules (Waqf) with selected verses from Juz Amma",
                    "Work on the rules of Meem Sakinah through call-and-response exercises"
                ];
                
                const randomIdea = ideas[Math.floor(Math.random() * ideas.length)];
                showMessage(`Lesson Idea: ${randomIdea}`);
                trackChange(`Generated lesson idea: ${randomIdea}`);
            });
        }

        // Render private contact info
        function renderPrivateContactInfo() {
            const privateContactBody = document.getElementById('privateContactBody');
            privateContactBody.innerHTML = '';
            
            privateContactData.forEach((contact, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="text" class="contact-name-input" data-index="${index}" value="${contact.name}"></td>
                    <td><input type="text" class="contact-phone-input" data-index="${index}" value="${contact.phone}"></td>
                    <td><input type="text" class="contact-email-input" data-index="${index}" value="${contact.email}"></td>
                    <td><input type="text" class="contact-notes-input" data-index="${index}" value="${contact.privateNotes}"></td>
                `;
                privateContactBody.appendChild(row);
            });
            
            // Add event listeners for contact info changes
            document.querySelectorAll('.contact-name-input').forEach(input => {
                input.addEventListener('change', (e) => {
                    const index = e.target.dataset.index;
                    const oldName = privateContactData[index].name;
                    const newName = e.target.value;
                    privateContactData[index].name = newName;
                    attendanceData[index].name = newName;
                    trackChange(`Changed contact name from "${oldName}" to "${newName}"`);
                    renderAttendance();
                    renderOverallAttendance();
                });
            });
            
            document.querySelectorAll('.contact-phone-input').forEach(input => {
                input.addEventListener('change', (e) => {
                    const index = e.target.dataset.index;
                    const oldPhone = privateContactData[index].phone;
                    const newPhone = e.target.value;
                    privateContactData[index].phone = newPhone;
                    trackChange(`Changed phone number for ${privateContactData[index].name} from "${oldPhone}" to "${newPhone}"`);
                });
            });
            
            document.querySelectorAll('.contact-email-input').forEach(input => {
                input.addEventListener('change', (e) => {
                    const index = e.target.dataset.index;
                    const oldEmail = privateContactData[index].email;
                    const newEmail = e.target.value;
                    privateContactData[index].email = newEmail;
                    trackChange(`Changed email for ${privateContactData[index].name} from "${oldEmail}" to "${newEmail}"`);
                });
            });
            
            document.querySelectorAll('.contact-notes-input').forEach(input => {
                input.addEventListener('change', (e) => {
                    const index = e.target.dataset.index;
                    const oldNotes = privateContactData[index].privateNotes;
                    const newNotes = e.target.value;
                    privateContactData[index].privateNotes = newNotes;
                    trackChange(`Updated private notes for ${privateContactData[index].name}`);
                });
            });
        }

        // Render overall attendance summary
        function renderOverallAttendance() {
            const overallAttendanceBody = document.getElementById('overallAttendanceBody');
            overallAttendanceBody.innerHTML = '';
            
            const totalDays = monthDates.length;
            
            attendanceData.forEach((student, index) => {
                let daysAttended = 0;
                for (const date in student.attendance) {
                    if (student.attendance[date]) daysAttended++;
                }
                
                const percentage = totalDays > 0 ? ((daysAttended / totalDays) * 100).toFixed(2) : 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.name}</td>
                    <td class="text-center">${daysAttended} / ${totalDays}</td>
                    <td class="text-center">${percentage}%</td>
                    <td>
                        <button class="btn bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-md text-sm generate-insight-btn" data-index="${index}">
                            ✨ Get Insight
                        </button>
                    </td>
                `;
                overallAttendanceBody.appendChild(row);
            });
            
            // Add event listeners for insight buttons
            document.querySelectorAll('.generate-insight-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const index = e.target.dataset.index;
                    const student = attendanceData[index];
                    let daysAttended = 0;
                    for (const date in student.attendance) {
                        if (student.attendance[date]) daysAttended++;
                    }
                    
                    const percentage = totalDays > 0 ? ((daysAttended / totalDays) * 100).toFixed(2) : 0;
                    const insight = `Attendance for ${student.name}: ${daysAttended}/${totalDays} days (${percentage}%). ${percentage > 80 ? 'Excellent attendance!' : percentage > 50 ? 'Good attendance' : 'Needs improvement'}`;
                    
                    showMessage(insight);
                    trackChange(`Generated insight for ${student.name}`);
                });
            });
        }

        // Open note modal
        function openNoteModal(type, index, date = null) {
            const modal = document.getElementById('noteModal');
            const title = document.getElementById('noteModalTitle');
            const textarea = document.getElementById('noteTextArea');
            const saveBtn = document.getElementById('saveNoteBtn');
            
            // Set modal content based on type
            if (type === 'student') {
                title.textContent = `Notes for ${attendanceData[index].name}`;
                textarea.value = attendanceData[index].studentNote;
                
                saveBtn.onclick = () => {
                    const oldNote = attendanceData[index].studentNote;
                    const newNote = textarea.value;
                    attendanceData[index].studentNote = newNote;
                    trackChange(`Updated notes for ${attendanceData[index].name}`);
                    modal.classList.add('hidden');
                };
            } else if (type === 'timetable') {
                const slot = timetableData[index];
                title.textContent = `Notes for ${slot.time} on ${date}`;
                textarea.value = slot.dailySubjects[date].note || '';
                
                saveBtn.onclick = () => {
                    const oldNote = slot.dailySubjects[date].note;
                    const newNote = textarea.value;
                    slot.dailySubjects[date].note = newNote;
                    trackChange(`Updated notes for ${slot.time} on ${date}`);
                    modal.classList.add('hidden');
                };
            }
            
            modal.classList.remove('hidden');
        }

        // Show message
        function showMessage(text) {
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            
            messageText.textContent = text;
            messageBox.classList.remove('hidden');
        }

        // Initialize the application when the page loads
        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>